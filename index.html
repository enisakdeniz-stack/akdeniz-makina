<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Akdeniz Takip Pro</title>

    <link rel="apple-touch-icon" href="https://i.ibb.co/Y7LRMkr3/1-A468574-4-AFF-42-EA-81-EA-7756-D9017-D56.png">
    <link rel="shortcut icon" href="https://i.ibb.co/Y7LRMkr3/1-A468574-4-AFF-42-EA-81-EA-7756-D9017-D56.png">

    <meta name="apple-mobile-web-app-title" content="Akdeniz Takip">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF Kütüphaneleri -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body, html { background: white; height: auto !important; overflow: visible !important; }
            #root { display: block !important; }
            #receipt-paper { border: none !important; box-shadow: none !important; width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="module">
        // GÜNCELLEME: Firebase Auth kütüphanelerini ekledik
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, limit, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const { useState, useEffect, useMemo } = React;
        const { flushSync } = ReactDOM;

        const firebaseConfig = {
            apiKey: "AIzaSyDb--JGJG7gdHcAXXGtvwT9FmrRnxjvCvo",
            authDomain: "cnc-takip-460b6.firebaseapp.com",
            projectId: "cnc-takip-460b6",
            storageBucket: "cnc-takip-460b6.firebasestorage.app",
            messagingSenderId: "cnc-takip-460b6.firebasestorage.app",
            appId: "1:627287710354:web:4b04d452c51ac793bda44b"
        };

        let app, db, auth, dbError = null;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app); // GÜNCELLEME: Kimlik sistemi başlatıldı
        } catch (e) {
            console.error(e);
            dbError = e.message;
        }

        const LOGO_LINKI = "https://i.ibb.co/Y7LRMkr3/1-A468574-4-AFF-42-EA-81-EA-7756-D9017-D56.png"; 

        const CURRENCIES = {
            TRY: { label: 'TL', symbol: '₺' },
            USD: { label: 'USD', symbol: '$' },
            EUR: { label: 'EUR', symbol: '€' }
        };

        const getTodayDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const trToEn = (str) => {
            if (!str) return "";
            return str
                .replace(/Ğ/g, "G").replace(/ğ/g, "g")
                .replace(/Ü/g, "U").replace(/ü/g, "u")
                .replace(/Ş/g, "S").replace(/ş/g, "s")
                .replace(/İ/g, "I").replace(/ı/g, "i")
                .replace(/Ö/g, "O").replace(/ö/g, "o")
                .replace(/Ç/g, "C").replace(/ç/g, "c")
                .replace(/₺/g, "TL");
        };

        const Icon = (p) => React.createElement("svg", {...p, xmlns:"http://www.w3.org/2000/svg", width:"24", height:"24", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"});
        const IconCheck = () => Icon({children: [React.createElement("polyline", {points:"20 6 9 17 4 12"})]});
        const IconEdit = (props) => Icon({...props, children: [React.createElement("path", {d:"M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"})]});
        const IconTrash = (props) => Icon({...props, className:"text-red-500", children: [React.createElement("path", {d:"M3 6h18"}), React.createElement("path", {d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}), React.createElement("path", {d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]});
        const IconAlert = () => Icon({className:"text-yellow-500 mx-auto mb-2", width:48, height:48, children: [React.createElement("path", {d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}), React.createElement("line", {x1:"12", y1:"9", x2:"12", y2:"13"}), React.createElement("line", {x1:"12", y1:"17", x2:"12.01", y2:"17"})]});
        const IconFlag = () => Icon({className:"text-red-600 fill-red-100", children: [React.createElement("path", {d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"}), React.createElement("line", {x1:"4", x2:"4", y1:"22", y2:"15"})]});
        const IconClose = () => Icon({children: [React.createElement("path", {d:"M18 6 6 18"}), React.createElement("path", {d:"m6 6 12 12"})]});
        const IconSearch = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"20", height:"20", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round", className:"text-gray-400"}, React.createElement("circle", {cx:"11", cy:"11", r:"8"}), React.createElement("line", {x1:"21", x2:"16.65", y1:"21", y2:"16.65"}));
        const IconPrinter = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"18", height:"18", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round", className:"text-white"}, React.createElement("polyline", {points:"6 9 6 2 18 2 18 9"}), React.createElement("path", {d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"}), React.createElement("rect", {width:"12", height:"8", x:"6", y:"14"}));
        const IconChart = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"20", height:"20", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"}, React.createElement("path", {d:"M18 20V10"}), React.createElement("path", {d:"M12 20V4"}), React.createElement("path", {d:"M6 20v-6"}));
        const IconCalendar = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"16", height:"16", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"}, React.createElement("rect", {x:"3", y:"4", width:"18", height:"18", rx:"2", ry:"2"}), React.createElement("line", {x1:"16", y1:"2", x2:"16", y2:"6"}), React.createElement("line", {x1:"8", y1:"2", x2:"8", y2:"6"}), React.createElement("line", {x1:"3", y1:"10", x2:"21", y2:"10"}));
        const IconEye = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"18", height:"18", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round", className:"text-blue-600"}, React.createElement("path", {d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"}), React.createElement("circle", {cx:"12", cy:"12", r:"3"}));
        const IconArrowLeft = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"20", height:"20", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"}, React.createElement("line", {x1:"19", y1:"12", x2:"5", y2:"12"}), React.createElement("polyline", {points:"12 19 5 12 12 5"}));
        const IconMessageCircle = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"20", height:"20", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"}, React.createElement("path", {d:"M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"}));
        const IconFileText = () => React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", width:"20", height:"20", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"}, React.createElement("path", {d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}), React.createElement("polyline", {points:"14 2 14 8 20 8"}), React.createElement("line", {x1:"16", y1:"13", x2:"8", y2:"13"}), React.createElement("line", {x1:"16", y1:"17", x2:"8", y2:"17"}), React.createElement("polyline", {points:"10 9 9 9 8 9"}));

        function App() {
            if (dbError) return React.createElement("div", {className: "p-10 text-red-600 font-bold"}, "Hata: " + dbError);

            const MACHINES = [
                { id: 'T5', name: 'Makina T5', color: 'bg-orange-600', text:'text-orange-600', bg:'bg-orange-50' },
                { id: 'A25', name: 'Makina A25', color: 'bg-blue-600', text:'text-blue-600', bg:'bg-blue-50' },
                { id: 'A32', name: 'Makina A32', color: 'bg-emerald-600', text:'text-emerald-600', bg:'bg-emerald-50' }
            ];

            const [user, setUser] = useState(null); // GÜNCELLEME: Kullanıcı Takibi
            const [activeTab, setActiveTab] = useState('entry');
            const [isLoading, setIsLoading] = useState(true);
            const [showToast, setShowToast] = useState(false);
            const [viewMode, setViewMode] = useState('app'); 

            // STATE - CNC
            const [activeMachine, setActiveMachine] = useState(MACHINES[0].id);
            const [partName, setPartName] = useState('');
            const [inputCounter, setInputCounter] = useState('');
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(getTodayDate());
            const [editLog, setEditLog] = useState(null);
            const [showEditModal, setShowEditModal] = useState(false);
            
            // GEÇMİŞ MODLARI
            const [historyMode, setHistoryMode] = useState('date');
            const [historySearchTerm, setHistorySearchTerm] = useState('');

            // OPTİMİZASYON VE LİSTELER
            const [recentLogs, setRecentLogs] = useState([]); 
            const [historyLogs, setHistoryLogs] = useState([]); 
            const [partHistoryLogs, setPartHistoryLogs] = useState([]); 
            const [isHistoryLoading, setIsHistoryLoading] = useState(false);
            
            const [batchResets, setBatchResets] = useState([]);
            
            // STATE - MODAL (ORTAK)
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState(null); 
            const [modalData, setModalData] = useState({});

            // STATE - SATIŞ
            const [salesDate, setSalesDate] = useState(getTodayDate());
            const [customer, setCustomer] = useState('');
            const [product, setProduct] = useState('');
            const [count, setCount] = useState('');
            const [price, setPrice] = useState('');
            const [currency, setCurrency] = useState('TRY');
            const [taxIncluded, setTaxIncluded] = useState(false);
            const [cart, setCart] = useState([]);
            const [sales, setSales] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [productSearchTerm, setProductSearchTerm] = useState('');
            const [selectedSalesMonth, setSelectedSalesMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM
            const [showAllTimeSales, setShowAllTimeSales] = useState(false);
            const [editingSaleId, setEditingSaleId] = useState(null);
            const [printSale, setPrintSale] = useState(null);
            const [isSalesFormOpen, setIsSalesFormOpen] = useState(false);
            const [showReportModal, setShowReportModal] = useState(false);

            // GÜNCELLEME: UYGULAMA AÇILDIĞINDA OTOMATİK GİRİŞ YAP
            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u); // Zaten giriş yapmış
                    } else {
                        // Giriş yapmamışsa, gizlice giriş yap
                        signInAnonymously(auth).catch((error) => {
                            console.error("Giriş hatası:", error);
                        });
                    }
                });
                return () => unsubAuth();
            }, []);

            // 1. ANA VERİ DİNLEYİCİSİ (SADECE GİRİŞ YAPILDIYSA ÇALIŞIR)
            useEffect(() => {
                if (!db || !user) return; // User yoksa veri çekmeye çalışma
                
                const qRecent = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(150));
                
                const unsubLogs = onSnapshot(qRecent, (s) => { 
                    setRecentLogs(s.docs.map(d => ({ id: d.id, ...d.data() }))); 
                    setIsLoading(false); 
                }, (error) => {
                    console.log("Henüz yetki yok, bekleniyor...");
                });

                const unsubResets = onSnapshot(query(collection(db, "resets"), orderBy("resetDate", "desc"), limit(50)), (s) => setBatchResets(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSales = onSnapshot(query(collection(db, "sales_demo"), orderBy("timestamp", "desc"), limit(100)), (s) => setSales(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                
                return () => { unsubLogs(); unsubResets(); unsubSales(); };
            }, [user]); // user değişkeni değişince (giriş yapılınca) burası çalışır

            // 2. GEÇMİŞ: TARİH BAZLI DİNLEYİCİ
            useEffect(() => {
                if (!db || !selectedHistoryDate || historyMode !== 'date' || !user) return;
                
                setIsHistoryLoading(true);
                const qHistory = query(collection(db, "logs"), where("date", "==", selectedHistoryDate), orderBy("timestamp", "desc"));
                
                const unsubHistory = onSnapshot(qHistory, (s) => {
                    setHistoryLogs(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    setIsHistoryLoading(false);
                });

                return () => unsubHistory();
            }, [selectedHistoryDate, historyMode, user]);

            // 3. GEÇMİŞ: PARÇA BAZLI DİNLEYİCİ
            useEffect(() => {
                if (!db || historyMode !== 'part' || !historySearchTerm || !user) {
                    setPartHistoryLogs([]);
                    return;
                }
                
                setIsHistoryLoading(true);
                const qPart = query(
                    collection(db, "logs"), 
                    where("partName", "==", historySearchTerm.toUpperCase().trim()), 
                    orderBy("timestamp", "desc"), 
                    limit(50)
                );
                
                const unsubPart = onSnapshot(qPart, (s) => {
                    setPartHistoryLogs(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    setIsHistoryLoading(false);
                });

                return () => unsubPart();
            }, [historySearchTerm, historyMode, user]);

            const formatMoney = (val, cur) => {
                const currencyInfo = CURRENCIES[cur] || CURRENCIES.TRY; 
                const symbol = currencyInfo.symbol;
                return (val || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' ' + symbol;
            };

            const cartTotals = useMemo(() => {
                let subTotal = 0;
                let kdvTotal = 0;
                cart.forEach(item => {
                    const itemRawTotal = (item.count || 0) * (item.price || 0);
                    subTotal += itemRawTotal;
                    kdvTotal += (item.kdvValue || 0);
                });
                const grandTotal = subTotal + kdvTotal;
                const activeCurrency = (cart.length > 0 && cart[0].currency) ? cart[0].currency : 'TRY';
                return { subTotal, kdvTotal, grandTotal, currency: activeCurrency };
            }, [cart]);

            const uniqueProducts = useMemo(() => {
                const fromLogs = recentLogs.map(l => l.partName);
                const fromResets = batchResets.map(r => r.partName);
                return Array.from(new Set([...fromLogs, ...fromResets])).sort();
            }, [recentLogs, batchResets]);
            
            const latestReset = useMemo(() => { 
                if(!partName) return null; 
                const pName = partName.toUpperCase().trim(); 
                const pResets = batchResets.filter(r => r.partName === pName); 
                return pResets.length ? pResets[0] : null; 
            }, [batchResets, partName]);

            const lastRecord = useMemo(() => { 
                if(!partName) return null; 
                const pName = partName.toUpperCase().trim(); 
                let relevantLogs = recentLogs.filter(l => l.partName === pName && l.machineId === activeMachine && l.totalCounter !== undefined); 
                if (latestReset) relevantLogs = relevantLogs.filter(l => new Date(l.timestamp) > new Date(latestReset.resetDate)); 
                return relevantLogs.length > 0 ? relevantLogs[0] : null; 
            }, [recentLogs, latestReset, partName, activeMachine]);

            const lastCounterValue = lastRecord ? lastRecord.totalCounter : 0;
            const isFirstRecordOfBatch = !lastRecord;

            const stats = useMemo(() => { 
                if (!partName) return { daily: 0, batch: 0, yearly: 0 }; 
                const pNameUpper = partName.toUpperCase().trim(); 
                const todayStr = getTodayDate(); 
                const resets = batchResets.filter(r => r.partName === pNameUpper).sort((a,b) => new Date(b.resetDate) - new Date(a.resetDate)); 
                const lastReset = resets.length ? new Date(resets[0].resetDate) : new Date(0); 
                let s = { daily: 0, batch: 0 }; 
                recentLogs.forEach(l => { 
                    if (l.partName === pNameUpper) { 
                        if (l.date === todayStr) s.daily += l.count; 
                        if (new Date(l.timestamp) > lastReset) s.batch += l.count; 
                    } 
                }); 
                return s; 
            }, [recentLogs, batchResets, partName]);

            const yesterdaySummary = useMemo(() => { 
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); 
                const yesterdayStr = yesterday.toISOString().split('T')[0]; 
                const filteredLogs = recentLogs.filter(l => l.date === yesterdayStr); 
                const summary = filteredLogs.reduce((acc, log) => { const key = `${log.machineId}-${log.partName}`; if (!acc[key]) acc[key] = { machineId: log.machineId, partName: log.partName, totalProduction: 0, lastCounter: 0, timestamp: log.timestamp, isFinished: false, machineColor: MACHINES.find(m => m.id === log.machineId)?.color || 'bg-gray-500' }; acc[key].totalProduction += log.count; if (new Date(log.timestamp) >= new Date(acc[key].timestamp)) { acc[key].lastCounter = log.totalCounter; acc[key].timestamp = log.timestamp; if (log.type === 'finish') acc[key].isFinished = true; } return acc; }, {}); return Object.values(summary); 
            }, [recentLogs, MACHINES]);

            const filteredSales = useMemo(() => {
                let result = sales;
                if (!showAllTimeSales) {
                    result = result.filter(s => s.date && s.date.startsWith(selectedSalesMonth));
                }
                if (searchTerm) result = result.filter(s => s.customer.includes(searchTerm.toUpperCase()));
                if (productSearchTerm) result = result.filter(s => s.items && s.items.some(i => i.product.includes(productSearchTerm.toUpperCase())));
                return result;
            }, [sales, searchTerm, productSearchTerm, selectedSalesMonth, showAllTimeSales]);

            const uniqueCustomers = useMemo(() => [...new Set(sales.map(s => s.customer))].sort(), [sales]);
            const uniqueSalesProducts = useMemo(() => {
                const saleProds = sales.flatMap(s => s.items || []).map(i => i.product);
                return [...new Set(saleProds)].sort();
            }, [sales]);

            const salesStats = useMemo(() => {
                const now = new Date();
                let monthlyTotal = 0; let yearlyTotal = 0;
                sales.forEach(s => {
                    const d = new Date(s.date);
                    if (d.getFullYear() === now.getFullYear()) {
                        yearlyTotal += s.grandTotal;
                        if (d.getMonth() === now.getMonth()) monthlyTotal += s.grandTotal;
                    }
                });
                return { monthlyTotal, yearlyTotal };
            }, [sales]);

            const reportData = useMemo(() => {
                const productStats = {}; const customerStats = {}; const currentYear = new Date().getFullYear();
                sales.forEach(s => {
                    if (new Date(s.date).getFullYear() === currentYear) {
                        if (!customerStats[s.customer]) customerStats[s.customer] = 0; customerStats[s.customer] += s.grandTotal;
                        if (s.items) { s.items.forEach(item => { if (!productStats[item.product]) productStats[item.product] = 0; productStats[item.product] += item.count; }); }
                    }
                });
                const sortedProducts = Object.entries(productStats).sort((a,b) => b[1] - a[1]);
                const sortedCustomers = Object.entries(customerStats).sort((a,b) => b[1] - a[1]);
                return { sortedProducts, sortedCustomers };
            }, [sales]);

            const mConfig = MACHINES.find(m => m.id === activeMachine) || MACHINES[0];
            
            const handleDownloadPdf = () => {
                if(!window.jspdf) { alert("PDF motoru yüklenemedi."); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a5' });
                const trDate = new Date(printSale.date).toLocaleDateString('tr-TR');

                doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.text(trToEn("AKDENIZ MAKINA"), 74, 15, { align: 'center' });
                doc.setFontSize(12); doc.setFont("helvetica", "normal"); doc.text(trToEn("TESLIM FISI / FATURA"), 74, 23, { align: 'center' });
                doc.line(10, 26, 138, 26);
                doc.setFontSize(10); doc.text(trToEn(`SAYIN: ${printSale.customer}`), 10, 35); doc.text(trToEn(`Tarih: ${trDate}`), 10, 40); doc.text(trToEn(`Fis No: ${printSale.timestamp.slice(-6)}`), 138, 35, { align: 'right' });

                const tableColumn = ["URUN", "MIK.", "FIYAT", "TUTAR"];
                const tableRows = [];
                (printSale.items || []).forEach(item => {
                    const itemData = [ trToEn(item.product), item.count, formatMoney(item.price, item.currency).replace('₺', 'TL').replace('€', 'EUR').replace('$', 'USD'), formatMoney(item.total, item.currency).replace('₺', 'TL').replace('€', 'EUR').replace('$', 'USD') ];
                    tableRows.push(itemData);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 45, theme: 'grid', headStyles: { fillColor: [50, 50, 50], textColor: [255, 255, 255], fontStyle: 'bold' }, styles: { fontSize: 9, font: 'helvetica' }, margin: { left: 10, right: 10 } });

                let finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10); doc.text(trToEn(`Ara Toplam: ${formatMoney(printSale.subTotal, printSale.currency).replace('₺','TL')}`), 138, finalY, { align: 'right' });
                doc.text(trToEn(`KDV Toplam: ${formatMoney(printSale.kdvTotal, printSale.currency).replace('₺','TL')}`), 138, finalY + 5, { align: 'right' });
                doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text(trToEn(`GENEL TOPLAM: ${formatMoney(printSale.grandTotal, printSale.currency).replace('₺','TL')}`), 138, finalY + 12, { align: 'right' });
                doc.setFontSize(8); doc.setFont("helvetica", "italic"); doc.setTextColor(150); doc.text(trToEn("Tesekkur Ederiz."), 74, finalY + 25, { align: 'center' });
                doc.save(`fis-${printSale.timestamp.slice(-6)}.pdf`);
            };

            const handleSaveClick = () => { if(!partName || !inputCounter) return alert("Eksik bilgi!"); const current = parseInt(inputCounter); if(isNaN(current)) return alert("Geçersiz sayı"); if (isFirstRecordOfBatch && current > 0) { setModalType('initial_ask'); setModalData({ current }); setShowModal(true); return; } let production = current - lastCounterValue; if(production < 0) production = 0; setModalType('save'); setModalData({ current, production, prev: lastCounterValue }); setShowModal(true); };
            const handleFinishClick = () => { if(!partName || !inputCounter) return alert("Eksik bilgi!"); const current = parseInt(inputCounter); let production = current - lastCounterValue; if(isFirstRecordOfBatch && current > 0) { setModalType('finish_initial'); setModalData({ current }); setShowModal(true); return; } setModalType('finish'); setModalData({ current, production, prev: lastCounterValue }); setShowModal(true); };
            
            const executeSave = async (isInitial) => { setShowModal(false); try { const current = parseInt(inputCounter); let production = (isInitial || modalType === 'initial_ask') ? (modalType === 'initial_ask' && !isInitial ? current : 0) : current - lastCounterValue; if(production < 0) production = 0; await addDoc(collection(db, "logs"), { machineId: activeMachine, partName: partName.toUpperCase().trim(), count: production, totalCounter: current, date: getTodayDate(), timestamp: new Date().toISOString() }); setInputCounter(''); setShowToast(true); setTimeout(()=>setShowToast(false), 2000); } catch(e) { alert("Hata: " + e.message); } };
            const executeFinish = async (isInitial) => { setShowModal(false); try { const current = parseInt(inputCounter); let production = (isInitial || modalType === 'finish_initial') ? (modalType === 'finish_initial' && !isInitial ? current : 0) : current - lastCounterValue; if(production < 0) production = 0; if (production > 0 || isInitial) { await addDoc(collection(db, "logs"), { machineId: activeMachine, partName: partName.toUpperCase().trim(), count: production, totalCounter: current, type: 'finish', date: getTodayDate(), timestamp: new Date().toISOString() }); } setTimeout(async () => { await addDoc(collection(db, "resets"), { partName: partName.toUpperCase().trim(), resetDate: new Date().toISOString() }); setInputCounter(''); alert("Parti Kapatıldı."); }, 500); } catch(e) { alert("Hata: " + e.message); } };
            
            const handleEditSave = async () => { if(!editLog) return; try { await updateDoc(doc(db, "logs", editLog.id), { machineId: editLog.machineId, count: parseInt(editLog.count), totalCounter: editLog.totalCounter ? parseInt(editLog.totalCounter) : null, date: editLog.date, partName: editLog.partName.toUpperCase(), type: editLog.type }); setShowEditModal(false); setEditLog(null); alert("Güncellendi."); } catch (e) { alert("Hata: " + e.message); } };
            const executeDelete = async () => { setShowModal(false); if(editLog) { await deleteDoc(doc(db, "logs", editLog.id)); setEditLog(null); setShowEditModal(false); } };

            const handleAddToCart = () => { if (!product || !count || !price) return alert("Eksik bilgi!"); const numCount = parseFloat(count); const numPrice = parseFloat(price); const subTotal = numCount * numPrice; const kdv = taxIncluded ? subTotal * 0.20 : 0; const newItem = { id: Date.now(), product: product.toUpperCase(), count: numCount, price: numPrice, currency: currency, taxIncluded, total: subTotal + kdv, kdvValue: kdv }; setCart([...cart, newItem]); setProduct(''); setCount(''); setPrice(''); };
            const handleSaveSale = async () => { if (!customer || cart.length === 0) return alert("Hata: Sepet boş."); const saleData = { date: salesDate, customer: customer.toUpperCase(), items: cart, subTotal: cartTotals.subTotal, kdvTotal: cartTotals.kdvTotal, grandTotal: cartTotals.grandTotal, currency: cartTotals.currency, timestamp: new Date().toISOString() }; try { if (editingSaleId) { await updateDoc(doc(db, "sales_demo", editingSaleId), saleData); setEditingSaleId(null); } else { await addDoc(collection(db, "sales_demo"), saleData); } setCart([]); setCustomer(''); setIsSalesFormOpen(false); alert("İşlem Başarılı."); } catch (e) { alert("Hata: " + e.message); } };
            const startEditSale = (sale) => { setEditingSaleId(sale.id); setCustomer(sale.customer); setSalesDate(sale.date); setCart(sale.items || []); setIsSalesFormOpen(true); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            
            const openReceiptMode = (sale) => {
                flushSync(() => {
                    setPrintSale(sale);
                    setViewMode('receipt'); 
                });
            };

            const askDeleteSale = (id, e) => { if(e) e.stopPropagation(); setModalData({ saleId: id }); setModalType('delete_sale'); setShowModal(true); };
            const executeDeleteSale = async () => { setShowModal(false); if(modalData.saleId) { await deleteDoc(doc(db, "sales_demo", modalData.saleId)); setPrintSale(null); setEditingSaleId(null); } };

            const ReceiptView = () => {
                if (!printSale) return null;
                let pSubTotal = printSale.subTotal; let pKdvTotal = printSale.kdvTotal;
                if (pSubTotal === undefined || pKdvTotal === undefined) { pSubTotal = 0; pKdvTotal = 0; (printSale.items || []).forEach(i => { const raw = i.count * i.price; pSubTotal += raw; pKdvTotal += (i.kdvValue || 0); }); }
                
                return React.createElement("div", {className: "min-h-screen bg-white flex flex-col items-center pb-32 relative"},
                    React.createElement("div", {id: "receipt-paper", className: "w-full max-w-lg bg-white p-8"},
                        React.createElement("div", {className: "border-b-2 border-black pb-4 mb-4"}, 
                            React.createElement("h1", {className: "text-2xl font-bold text-center"}, "AKDENİZ MAKİNA"), 
                            React.createElement("h2", {className: "text-xl font-bold mt-6 text-center border-t border-black pt-4"}, "TESLİM FİŞİ / FATURA")
                        ),
                        React.createElement("div", {className: "flex justify-between mb-6 text-sm"}, React.createElement("div", {}, React.createElement("strong", {}, "SAYIN: "), React.createElement("div", {className:"uppercase font-semibold"}, printSale.customer), React.createElement("div", {className:"mt-1 text-xs text-gray-500"}, "Tarih: " + new Date(printSale.date).toLocaleDateString('tr-TR'))), React.createElement("div", {className: "text-right"}, React.createElement("strong", {}, "Fiş No: "), React.createElement("div", {}, printSale.timestamp.slice(-6)))),
                        React.createElement("table", {className: "w-full border-collapse border border-black mb-6 text-sm"}, React.createElement("thead", {}, React.createElement("tr", {className: "bg-gray-100"}, React.createElement("th", {className: "border border-black p-2 text-left"}, "Ürün"), React.createElement("th", {className: "border border-black p-2 text-center"}, "Mik."), React.createElement("th", {className: "border border-black p-2 text-right"}, "Fiyat"), React.createElement("th", {className: "border border-black p-2 text-right"}, "Tutar"))), React.createElement("tbody", {}, (printSale.items || []).map((item, i) => React.createElement("tr", {key: i}, React.createElement("td", {className: "border border-black p-2"}, item.product), React.createElement("td", {className: "border border-black p-2 text-center"}, item.count), React.createElement("td", {className: "border border-black p-2 text-right"}, formatMoney(item.price, item.currency)), React.createElement("td", {className: "border border-black p-2 text-right"}, formatMoney(item.total, item.currency)))))),
                        React.createElement("div", {className: "flex justify-end"}, 
                            React.createElement("div", {className: "w-2/3 space-y-1 text-right text-sm"}, 
                                React.createElement("div", {className: "flex justify-between"}, React.createElement("span", {}, "Ara Toplam:"), React.createElement("span", {}, formatMoney(pSubTotal, printSale.currency || 'TRY'))), 
                                React.createElement("div", {className: "flex justify-between"}, React.createElement("span", {}, "Toplam KDV:"), React.createElement("span", {}, formatMoney(pKdvTotal, printSale.currency || 'TRY'))), 
                                React.createElement("div", {className: "flex justify-between text-xl font-bold border-t border-black pt-2 mt-2"}, React.createElement("span", {}, "GENEL TOPLAM:"), React.createElement("span", {}, formatMoney(printSale.grandTotal, printSale.currency || 'TRY')))
                            )
                        ),
                        React.createElement("div", {className: "mt-10 text-center text-xs text-gray-400"}, "Teşekkür Ederiz.")
                    ),
                    React.createElement("div", {className: "fixed bottom-0 left-0 w-full p-4 bg-white border-t border-gray-200 flex gap-2 z-[999] no-print safe-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]"},
                        React.createElement("button", {onClick: () => setViewMode('app'), className: "flex-none w-14 py-3 bg-slate-100 rounded-xl font-bold text-slate-600 flex justify-center items-center active:bg-slate-200"}, React.createElement(IconArrowLeft)),
                        // Whatsapp kaldırıldı, PDF tek başına
                        React.createElement("button", {onClick: handleDownloadPdf, className: "flex-1 py-3 bg-blue-600 rounded-xl font-bold text-white flex justify-center items-center gap-2 shadow-lg active:bg-blue-700 text-xs md:text-sm"}, React.createElement(IconFileText), "PDF İNDİR")
                    )
                );
            };

            if (viewMode === 'receipt') {
                return React.createElement(ReceiptView);
            }

            // Hangi liste gösterilecek?
            const displayLogs = historyMode === 'date' ? historyLogs : partHistoryLogs;

            return React.createElement("div", {className: "min-h-screen pb-20 font-sans safe-pt bg-slate-50 relative"},
                React.createElement("datalist", {id: "prods"}, uniqueProducts.map(p=>React.createElement("option", {key: p, value: p}))), // ÖNEMLİ: id="prods" tüm inputlar için kaynak
                React.createElement("datalist", {id: "saleCustomerList"}, uniqueCustomers.map(c => React.createElement("option", {key: c, value: c}))),
                React.createElement("datalist", {id: "saleProductList"}, uniqueSalesProducts.map(p => React.createElement("option", {key: p, value: p}))),
                
                showModal && React.createElement("div", {className: "fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 no-print"},
                    React.createElement("div", {className: "bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center animate-fade-in"},
                         (modalType === 'delete_sale') && React.createElement("div", {}, 
                             React.createElement(IconTrash, {width:48, height:48, className:"mx-auto mb-2 text-red-500"}), 
                             React.createElement("h3", {className:"font-bold mb-2 text-red-600 text-lg uppercase"}, "Satış Silinsin mi?"), 
                             React.createElement("p", {className:"mb-6 text-slate-500"}, "Bu işlem geri alınamaz."), 
                             React.createElement("div", {className:"flex gap-3"},
                                React.createElement("button", {onClick: ()=>setShowModal(false), className: "flex-1 py-3 bg-slate-100 rounded-xl font-bold"}, "VAZGEÇ"),
                                React.createElement("button", {onClick: executeDeleteSale, className: "flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-100"}, "EVET, SİL")
                             )
                         ),
                         (modalType === 'initial_ask' || modalType === 'finish_initial') && React.createElement("div", {}, React.createElement(IconAlert), React.createElement("h3", {className: "font-bold mb-2"}, "İlk Giriş"), React.createElement("p", {className: "mb-4"}, `Girdiğin ${modalData.current} sayısı Başlangıç mı, Üretim mi?`), React.createElement("button", {onClick: ()=>modalType==='finish_initial'?executeFinish(true):executeSave(true), className: "w-full py-3 bg-yellow-100 rounded-xl font-bold mb-2"}, "BAŞLANGIÇ (Üretim=0)"), React.createElement("button", {onClick: ()=>modalType==='finish_initial'?executeFinish(false):executeSave(false), className: "w-full py-3 bg-blue-600 text-white rounded-xl font-bold"}, "ÜRETİM")),
                         (modalType === 'save' || modalType === 'finish') && React.createElement("div", {}, modalType === 'finish' ? React.createElement(IconFlag) : React.createElement(IconCheck), React.createElement("h3", {className: "font-bold mb-2"}, modalType === 'finish' ? "Partiyi Bitir" : "Kaydet"), React.createElement("div", {className: "text-left bg-slate-100 p-4 rounded-xl mb-4"}, React.createElement("div", {}, `Eski Sayaç: ${modalData.prev}`), React.createElement("div", {}, `Yeni Sayaç: ${modalData.current}`), React.createElement("div", {className:"text-green-600 font-bold"}, `Üretim: +${modalData.production}`)), React.createElement("div", {className: "flex gap-2"}, React.createElement("button", {onClick: ()=>setShowModal(false), className: "flex-1 py-3 bg-slate-200 rounded-xl"}, "İptal"), React.createElement("button", {onClick: ()=>modalType==='finish'?executeFinish(false):executeSave(false), className: `flex-1 py-3 text-white rounded-xl font-bold ${modalType==='finish'?'bg-red-600':'bg-blue-600'}`}, "ONAYLA"))),
                         (modalType === 'delete' || modalType === 'delete_log') && React.createElement("div", {}, React.createElement(IconTrash), React.createElement("h3", {className:"font-bold mb-2 text-red-600"}, "Kayıt Silinsin mi?"), React.createElement("p", {className:"mb-4"}, "Emin misin?"), React.createElement("button", {onClick: executeDelete, className: "w-full py-3 bg-red-600 text-white rounded-xl font-bold"}, "SİL"))
                    )
                ),
                
                showEditModal && editLog && React.createElement("div", {className: "fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 no-print"}, React.createElement("div", {className: "bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden"}, React.createElement("div", {className: "bg-slate-100 p-4 border-b flex justify-between items-center"}, React.createElement("h3", {className: "font-bold"}, "Kaydı Düzenle"), React.createElement("button", {onClick: () => setShowEditModal(false)}, React.createElement(IconClose))), React.createElement("div", {className: "p-6 space-y-4"}, React.createElement("div", {}, React.createElement("label", {className: "text-xs font-bold text-gray-400"}, "MAKİNE"), React.createElement("div", {className: "grid grid-cols-3 gap-2 mt-1"}, MACHINES.map(m => React.createElement("button", {key: m.id, onClick: () => setEditLog({...editLog, machineId: m.id}), className: `p-2 rounded-lg text-xs font-bold border ${editLog.machineId === m.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-gray-500 border-gray-200'}`}, m.id)))), React.createElement("div", {}, React.createElement("label", {className: "text-xs font-bold text-gray-400"}, "MAKİNE SAYACI (Total)"), React.createElement("input", {type: "number", value: editLog.totalCounter || '', onChange: (e) => setEditLog({...editLog, totalCounter: e.target.value}), className: "w-full p-3 border rounded-xl font-bold text-lg bg-yellow-50"})), React.createElement("div", {}, React.createElement("label", {className: "text-xs font-bold text-gray-400"}, "ÜRETİM (Fark)"), React.createElement("input", {type: "number", value: editLog.count, onChange: (e) => setEditLog({...editLog, count: e.target.value}), className: "w-full p-3 border rounded-xl font-bold text-lg"})), React.createElement("div", {}, React.createElement("label", {className: "text-xs font-bold text-gray-400"}, "TARİH"), React.createElement("input", {type: "date", value: editLog.date, onChange: (e) => setEditLog({...editLog, date: e.target.value}), className: "w-full p-3 border rounded-xl"})), React.createElement("div", {className: "flex items-center gap-3 p-3 bg-red-50 rounded-xl border border-red-100"}, React.createElement("input", {type: "checkbox", checked: editLog.type === 'finish', onChange: (e) => setEditLog({...editLog, type: e.target.checked ? 'finish' : null}), className: "w-5 h-5 accent-red-600"}), React.createElement("label", {className: "text-sm font-bold text-red-700"}, "Bu Bitiş Kaydıdır (Bayrak Ekle)"))), React.createElement("div", {className: "p-4 bg-slate-50 border-t flex gap-3"}, React.createElement("button", {onClick: ()=>setModalType('delete')||setShowModal(true), className: "flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-bold"}, "SİL"), React.createElement("button", {onClick: handleEditSave, className: "flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold"}, "GÜNCELLE")))),

                React.createElement("div", {className: "bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-10 no-print"},
                    React.createElement("h1", {className: "font-bold flex gap-2 items-center"}, React.createElement("img", {src: LOGO_LINKI, className: "w-8 h-8 rounded-full bg-white"}), " Akdeniz Takip "),
                    React.createElement("div", {className: "bg-slate-800 rounded p-1 flex gap-1"},
                        React.createElement("button", {onClick: ()=>setActiveTab('entry'), className: `px-3 py-1 text-xs rounded ${activeTab==='entry'?'bg-slate-600':''}`}, "Giriş"),
                        React.createElement("button", {onClick: ()=>setActiveTab('history'), className: `px-3 py-1 text-xs rounded ${activeTab==='history'?'bg-slate-600':''}`}, "Geçmiş"),
                        React.createElement("button", {onClick: ()=>setActiveTab('sales'), className: `px-3 py-1 text-xs rounded ${activeTab==='sales'?'bg-purple-600 text-white':'text-purple-300'}`}, "Satış")
                    )
                ),

                React.createElement("main", {className: "max-w-md mx-auto p-4 space-y-4 no-print"},
                    activeTab === 'entry' && React.createElement("div", {className: "space-y-6"},
                         React.createElement("div", {className: "grid grid-cols-3 gap-2"}, MACHINES.map(m => React.createElement("button", {key: m.id, onClick: ()=>setActiveMachine(m.id), className: `py-3 rounded-xl border-b-4 ${activeMachine===m.id ? m.color+' text-white' : 'bg-white'}`}, m.id))),
                         React.createElement("div", {className: "bg-white p-5 rounded-2xl shadow-sm border space-y-4"},
                            React.createElement("div", {}, React.createElement("label", {className: "text-xs font-bold text-gray-400"}, "PARÇA"), React.createElement("input", {list: "prods", value: partName, onChange: e=>setPartName(e.target.value), className: "w-full p-3 bg-slate-50 border rounded-xl font-bold uppercase", placeholder: "MİL-1"})),
                            partName && React.createElement("div", {className: "grid grid-cols-3 gap-2 text-center bg-slate-50 p-3 rounded-xl"}, React.createElement("div", {}, React.createElement("div", {className:"text-[9px] text-gray-400"}, "BUGÜN"), React.createElement("div", {className:"font-bold"}, stats.daily)), React.createElement("div", {className:"text-blue-600"}, React.createElement("div", {className:"text-[9px]"}, "BU PARTİ"), React.createElement("div", {className:"font-bold text-lg"}, stats.batch)), React.createElement("div", {}, React.createElement("div", {className:"text-[9px] text-gray-400"}, "YIL"), React.createElement("div", {className:"font-bold"}, stats.yearly))),
                            React.createElement("div", {}, React.createElement("div", {className: "flex justify-between mb-1"}, React.createElement("label", {className: "text-xs font-bold text-gray-400"}, "MAKİNE SAYAÇ (TOPLAM)"), !isFirstRecordOfBatch && React.createElement("span", {className: "text-[10px] font-bold text-blue-600"}, "Önceki: " + lastCounterValue)), React.createElement("input", {type: "number", value: inputCounter, onChange: e=>setInputCounter(e.target.value), className: "w-full p-4 text-4xl font-bold text-center bg-slate-50 border rounded-xl", placeholder: "0", inputMode: "numeric"}), isFirstRecordOfBatch && inputCounter && React.createElement("div", {className: "text-xs text-center mt-2 text-yellow-600 font-bold"}, "Yeni Parti Başlangıcı")),
                            React.createElement("div", {className: "space-y-4"}, React.createElement("button", {onClick: handleSaveClick, className: `w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg ${mConfig.color}`}, "KAYDET"), React.createElement("button", {onClick: handleFinishClick, className: "w-full py-4 bg-red-600 rounded-xl text-white font-bold text-lg shadow-lg"}, "KAYDET VE BİTİR"))
                         ),
                         yesterdaySummary.length > 0 && React.createElement("div", {className: "space-y-2"}, React.createElement("h3", {className: "text-xs font-bold text-slate-400 pl-2"}, "DÜNÜN ÖZETİ"), yesterdaySummary.map((sum, idx) => React.createElement("div", {key: idx, className: `bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm ${sum.isFinished ? 'border-red-300 bg-red-50' : 'border-slate-200'}`}, React.createElement("div", {className: "flex items-center gap-3"}, React.createElement("div", {className: `text-[10px] font-bold text-white px-2 py-1 rounded ${sum.machineColor}`}, sum.machineId), React.createElement("div", {className: "text-sm font-bold text-slate-700"}, sum.partName)), React.createElement("div", {className: "text-right"}, React.createElement("div", {className: "text-sm font-bold text-green-600 flex items-center justify-end gap-1"}, sum.totalProduction + " Adet", sum.isFinished && React.createElement(IconFlag, {className: "text-red-600 w-4 h-4"})), React.createElement("div", {className: "text-sm font-bold text-gray-500"}, "Toplam (Sayaç): " + sum.lastCounter)))))
                    ),

                    activeTab === 'history' && React.createElement("div", {}, 
                        React.createElement("div", {className: "bg-white p-2 rounded-xl border mb-4 shadow-sm"}, 
                            React.createElement("div", {className: "flex bg-slate-100 p-1 rounded-lg mb-2"},
                                React.createElement("button", {onClick: ()=>setHistoryMode('date'), className: `flex-1 py-1 text-xs font-bold rounded-md ${historyMode==='date'?'bg-white shadow text-slate-800':'text-slate-400'}`}, "TARİHE GÖRE"),
                                React.createElement("button", {onClick: ()=>setHistoryMode('part'), className: `flex-1 py-1 text-xs font-bold rounded-md ${historyMode==='part'?'bg-white shadow text-slate-800':'text-slate-400'}`}, "PARÇA SORGULA")
                            ),
                            historyMode === 'date' ? 
                                React.createElement("input", {type: "date", value: selectedHistoryDate, onChange: e=>setSelectedHistoryDate(e.target.value), className: "w-full p-2 bg-slate-50 border rounded-lg font-bold"}) :
                                React.createElement("div", {},
                                    // Güncelleme: list="prods" kullanarak otomatik tamamlama
                                    React.createElement("input", {list: "prods", value: historySearchTerm, onChange: e=>setHistorySearchTerm(e.target.value), placeholder: "Parça Adı Yaz (Örn: MİL-1)", className: "w-full p-2 bg-slate-50 border rounded-lg font-bold uppercase"}),
                                    historySearchTerm && React.createElement("div", {className:"text-[10px] text-gray-400 mt-1 text-center"}, "Son 50 kayıt gösteriliyor")
                                )
                        ),
                        isHistoryLoading ? React.createElement("div", {className: "text-center p-10 text-gray-400 animate-pulse"}, "Yükleniyor...") :
                        displayLogs.length === 0 ? React.createElement("div", {className: "text-center p-10 text-gray-400 italic"}, "Kayıt bulunamadı.") :
                        displayLogs.map(l => { const mColor = MACHINES.find(m => m.id === l.machineId)?.color || 'bg-gray-500'; return React.createElement("div", {key: l.id, onClick: ()=>{setEditLog(l); setShowEditModal(true);}, className: `bg-white p-3 rounded-xl border mb-2 flex justify-between items-center cursor-pointer active:bg-slate-50 ${l.type==='finish'?'border-red-300 bg-red-50':''}`}, React.createElement("div", {}, React.createElement("span", {className: `text-xs font-bold text-white px-2 py-1 rounded mr-2 ${mColor}`}, l.machineId), React.createElement("span", {className: "font-bold"}, l.partName), React.createElement("div", {className:"text-[10px] text-gray-400 mt-1"}, historyMode==='part' ? new Date(l.date).toLocaleDateString('tr-TR') : '')), React.createElement("div", {className: "text-right"}, React.createElement("div", {className: "font-bold text-lg flex items-center justify-end gap-2"}, l.count, l.type === 'finish' && React.createElement("span", {className:"text-[10px] bg-red-600 text-white px-1 rounded flex items-center gap-1"}, "BİTTİ", React.createElement(IconFlag, {className:"w-3 h-3 text-white"}))), React.createElement("div", {className: "text-sm font-bold text-gray-500"}, "Toplam (Sayaç): " + (l.totalCounter || '-')))); })
                    ),

                    activeTab === 'sales' && React.createElement("div", {className: "space-y-4"},
                        React.createElement("div", {className: "flex gap-2"},
                            React.createElement("button", {onClick: ()=> setIsSalesFormOpen(!isSalesFormOpen), className: `flex-1 py-3 font-bold rounded-xl shadow-lg transition active:scale-95 ${isSalesFormOpen ? 'bg-slate-200' : 'bg-purple-600 text-white shadow-purple-200'}`}, 
                                isSalesFormOpen ? "KAPAT" : (editingSaleId ? "DÜZENLEMEYİ KAPAT" : "+ YENİ SATIŞ")
                            ),
                            React.createElement("button", {onClick: ()=>setShowReportModal(true), className: "w-12 bg-white text-purple-600 border border-purple-100 rounded-xl flex items-center justify-center shadow-sm"}, React.createElement(IconChart))
                        ),

                        isSalesFormOpen && React.createElement("div", {className: "bg-white p-4 rounded-2xl shadow-sm border border-purple-100 space-y-3 animate-fade-in"},
                            React.createElement("div", {className: "flex gap-2"},
                                React.createElement("input", {type: "date", value: salesDate, onChange: e=>setSalesDate(e.target.value), className: "w-1/3 p-2 border rounded-lg font-bold text-sm"}),
                                React.createElement("input", {list: "saleCustomerList", value: customer, onChange: e=>setCustomer(e.target.value), placeholder: "Müşteri Adı", className: "w-2/3 p-2 border rounded-lg font-bold uppercase text-sm"})
                            ),
                            React.createElement("div", {className: "bg-purple-50 p-3 rounded-xl border border-purple-100 space-y-2"},
                                React.createElement("div", {className: "flex gap-1 mb-1"}, Object.entries(CURRENCIES).map(([k,v]) => React.createElement("button", {key: k, onClick: ()=>setCurrency(k), className: `flex-1 py-1 text-[10px] font-bold rounded border ${currency===k?'bg-purple-600 text-white':'bg-white text-slate-400'}`}, v.label))),
                                React.createElement("input", {list: "saleProductList", value: product, onChange: e=>setProduct(e.target.value), placeholder: "Ürün Adı", className: "w-full p-2 border rounded-lg font-bold uppercase text-sm"}),
                                React.createElement("div", {className: "flex gap-2"},
                                    React.createElement("input", {type: "number", value: count, onChange: e=>setCount(e.target.value), placeholder: "Adet", className: "w-1/3 p-2 border rounded-lg text-center font-bold text-sm"}),
                                    React.createElement("input", {type: "number", value: price, onChange: e=>setPrice(e.target.value), placeholder: "Fiyat", className: "w-1/3 p-2 border rounded-lg text-center font-bold text-sm"}),
                                    React.createElement("button", {onClick: handleAddToCart, className: "w-1/3 bg-purple-600 text-white rounded-lg font-bold text-xs"}, "EKLE")
                                ),
                                React.createElement("label", {className: "flex items-center gap-2 text-[10px] font-bold text-purple-700 mt-1"},
                                    React.createElement("input", {type: "checkbox", checked: taxIncluded, onChange: e=>setTaxIncluded(e.target.checked), className: "w-3 h-3 accent-purple-600"}), "KDV (%20) Ekle"
                                )
                            ),
                            cart.length > 0 && React.createElement("div", {className: "space-y-2 pt-2"},
                                cart.map(item => React.createElement("div", {key: item.id, className: "flex justify-between text-xs border-b pb-2"}, 
                                    React.createElement("div", {}, React.createElement("div",{className:"font-bold"},item.product), 
                                    React.createElement("div",{className:"text-slate-400"},`${item.count} x ${item.price} ${CURRENCIES[item.currency]?.symbol || '₺'}`)), // Güvenli Erişim
                                    React.createElement("div", {className:"flex gap-2 items-center"}, React.createElement("span",{className:"font-bold"},formatMoney(item.total, item.currency)), React.createElement("button", {onClick:()=>setCart(cart.filter(c=>c.id!==item.id))}, React.createElement(IconClose,{width:14}))))),
                                
                                React.createElement("div", {className: "bg-slate-50 p-3 rounded-lg mt-3 text-sm space-y-1 text-right"},
                                    React.createElement("div", {className: "flex justify-between text-slate-500"}, React.createElement("span", {}, "Ara Toplam"), React.createElement("span", {}, formatMoney(cartTotals.subTotal, cartTotals.currency))),
                                    React.createElement("div", {className: "flex justify-between text-slate-500"}, React.createElement("span", {}, "KDV Toplam"), React.createElement("span", {}, formatMoney(cartTotals.kdvTotal, cartTotals.currency))),
                                    React.createElement("div", {className: "flex justify-between font-black text-lg text-purple-700 border-t pt-1"}, React.createElement("span", {}, "GENEL TOPLAM"), React.createElement("span", {}, formatMoney(cartTotals.grandTotal, cartTotals.currency)))
                                ),
                                
                                React.createElement("button", {onClick: handleSaveSale, className: "w-full mt-3 py-3 bg-purple-700 text-white font-bold rounded-xl shadow-lg"}, "KAYDET")
                            )
                        ),

                        React.createElement("div", {className: "bg-white p-3 rounded-2xl border border-slate-200 shadow-sm space-y-3"},
                            React.createElement("div", {className: "flex items-center justify-between border-b pb-2 mb-2"},
                                React.createElement("h3", {className: "text-xs font-black text-slate-400 uppercase flex items-center gap-1"}, React.createElement(IconCalendar, {width:16}), "SATIŞ ARŞİVİ"),
                                React.createElement("label", {className: "text-[10px] font-bold text-purple-600 flex items-center gap-1 cursor-pointer"}, 
                                    React.createElement("input", {type: "checkbox", checked: showAllTimeSales, onChange: e=>setShowAllTimeSales(e.target.checked), className: "accent-purple-600"}), "TÜM ZAMANLAR"
                                )
                            ),
                            !showAllTimeSales && React.createElement("div", {className: "flex gap-2 items-center"},
                                React.createElement("span", {className: "text-xs font-bold text-slate-500"}, "AY SEÇ:"),
                                React.createElement("input", {type: "month", value: selectedSalesMonth, onChange: e=>setSelectedSalesMonth(e.target.value), className: "flex-1 p-2 bg-slate-50 border rounded-lg font-bold text-sm outline-none"})
                            ),
                            React.createElement("div", {className: "flex gap-2"},
                                React.createElement("div", {className: "relative flex-1"},
                                    React.createElement("input", {value: searchTerm, onChange: e=>setSearchTerm(e.target.value), placeholder: "Müşteri Ara...", className: "w-full p-2.5 pl-8 border rounded-xl text-xs font-bold outline-none"}),
                                    React.createElement("div", {className: "absolute left-2.5 top-3"}, React.createElement(IconSearch, {width:16}))
                                ),
                                React.createElement("div", {className: "relative flex-1"},
                                    React.createElement("input", {value: productSearchTerm, onChange: e=>setProductSearchTerm(e.target.value), placeholder: "Ürün Ara...", className: "w-full p-2.5 pl-8 border rounded-xl text-xs font-bold outline-none"}),
                                    React.createElement("div", {className: "absolute left-2.5 top-3"}, React.createElement(IconSearch, {width:16}))
                                )
                            )
                        ),

                        React.createElement("div", {className: "space-y-2"},
                            filteredSales.length === 0 ? React.createElement("div", {className: "text-center p-10 text-slate-400 text-sm italic"}, "Bu kriterlere uygun satış bulunamadı.") :
                            filteredSales.map(sale => React.createElement("div", {key: sale.id, className: "bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative animate-fade-in"},
                                React.createElement("div", {className: "flex justify-between items-start"},
                                    React.createElement("div", {className:"flex-1", onClick: ()=>openReceiptMode(sale)},
                                        React.createElement("div", {className: "font-bold text-slate-800 text-lg"}, sale.customer),
                                        React.createElement("div", {className: "text-[10px] text-gray-400"}, new Date(sale.date).toLocaleDateString('tr-TR') + " • " + (sale.items?.length || 0) + " Kalem")
                                    ),
                                    React.createElement("div", {className: "text-right flex flex-col items-end gap-1"},
                                        React.createElement("div", {className: "font-black text-purple-700"}, formatMoney(sale.grandTotal, sale.currency || 'TRY')),
                                        React.createElement("div", {className: "flex gap-1"},
                                            React.createElement("button", {onClick: (e)=>{e.stopPropagation(); startEditSale(sale);}, className: "bg-blue-50 text-blue-600 p-1.5 rounded border border-blue-100"}, React.createElement(IconEdit, {width:16})),
                                            React.createElement("button", {onClick: (e)=> { e.stopPropagation(); openReceiptMode(sale); }, className: "bg-slate-50 text-slate-600 p-1.5 rounded border"}, React.createElement(IconEye, {width:16})),
                                            React.createElement("button", {onClick: (e)=> askDeleteSale(sale.id, e), className: "bg-red-50 text-red-600 p-1.5 rounded border border-red-100"}, React.createElement(IconTrash, {width:16}))
                                        )
                                    )
                                )
                            ))
                        )
                    )
                ),

                showReportModal && React.createElement("div", {className: "fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 no-print"},
                    React.createElement("div", {className: "bg-white w-full max-w-sm rounded-2xl shadow-2xl p-5 overflow-hidden flex flex-col max-h-[90vh]"},
                        React.createElement("div", {className: "flex justify-between items-center mb-4 border-b pb-2"}, React.createElement("h3", {className: "font-bold text-lg"}, "Yönetim Raporu"), React.createElement("button", {onClick: ()=>setShowReportModal(false), className: "p-2 bg-slate-100 rounded-full"}, React.createElement(IconClose))),
                        React.createElement("div", {className: "overflow-y-auto flex-1 pr-2 space-y-6"},
                            React.createElement("div", {className: "grid grid-cols-2 gap-3 mb-2"},
                                React.createElement("div", {className: "bg-purple-50 p-3 rounded-xl border border-purple-100"}, React.createElement("div", {className: "text-[10px] font-bold text-slate-500"}, "BU AY CİRO"), React.createElement("div", {className: "text-lg font-black text-purple-700"}, salesStats.monthlyTotal.toLocaleString('tr-TR', {maximumFractionDigits:0}) + "₺")),
                                React.createElement("div", {className: "bg-blue-50 p-3 rounded-xl border border-blue-100"}, React.createElement("div", {className: "text-[10px] font-bold text-slate-500"}, "BU YIL CİRO"), React.createElement("div", {className: "text-lg font-black text-slate-700"}, salesStats.yearlyTotal.toLocaleString('tr-TR', {maximumFractionDigits:0}) + "₺"))
                            ),
                            React.createElement("div", {},
                                React.createElement("h4", {className: "text-xs font-bold text-purple-700 uppercase mb-2"}, "En Çok Satan Ürünler"),
                                reportData.sortedProducts.length === 0 ? React.createElement("div", {className: "text-gray-400 text-sm"}, "Veri yok") : reportData.sortedProducts.map(([name, qty], i) => React.createElement("div", {key: i, className: "flex justify-between text-sm py-1 border-b border-slate-50"}, React.createElement("span", {}, name), React.createElement("span", {className: "font-bold"}, qty + " Adet")))
                            ),
                            React.createElement("div", {},
                                React.createElement("h4", {className: "text-xs font-bold text-purple-700 uppercase mb-2"}, "Müşteri Ciroları"),
                                reportData.sortedCustomers.length === 0 ? React.createElement("div", {className: "text-gray-400 text-sm"}, "Veri yok") : reportData.sortedCustomers.map(([name, total], i) => React.createElement("div", {key: i, className: "flex justify-between text-sm py-1 border-b border-slate-50"}, React.createElement("span", {}, name), React.createElement("span", {className: "font-bold"}, total.toLocaleString('tr-TR') + " ₺")))
                            )
                        )
                    )
                )
             );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>


